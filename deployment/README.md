# Deployment

==============================================

# WARNING

There MAY NOT be any files in this directory that are not committed to GitHub, like a .env file,
or the asset hash used in the pipeline description will be different than the one that Build stage calculates,
and Assets stage will not be able to find the assets generated by the Build stage, and thereby fail.

==============================================

## Overview

This deployment consists of a CDK Pipeline stack (an inception pipeline) that deploys the application stack. The CDK Pipeline is self-mutating (self_mutation=True), so when changes are committed on it's branch to GitHub, the CodePipeline will modify itself if necessary and then build and deploy the application.

One important point to remember with this type of pipeline is that any changes to the inception pipeline or the application **must** be committed to the GitHub repo branch, or else the pipeline with either self-modify itself back to the github state or install the code that's there. 

You must create a Pipeline in AWS for each stage that is to be deployed. These stages match branch names in GitHub.
For example, the `dit` branch will be deployed as the `dit` stage.

The stage names MUST consist only of alphanumeric and `-` characters, as these are the only valid AWS Stack names.

If you create a new stage name (e.g., one with your username in it for development), you must add a configuration for it to the `application.yml.maap`, `database.yml.maap`, and `services.yml` files.

You must also create an environment file in `config/environments/`, e.g.:

```bash
cp config/environments/dit.rb config/environments/aimee.rb

More information about CDK Pipelines can be found [here](https://docs.aws.amazon.com/cdk/latest/guide/cdk_pipeline.html).

Future work may be to replace the GitHub version 1 source action (personal token-based) to a version 2 source action(app-based) -- see [Update a GitHub version 1 source action to a GitHub version 2 source action](https://docs.aws.amazon.com/codepipeline/latest/userguide/update-github-action-connections.html).

## Inception Pipeline Deployment

1. Initial setup

```bash
# Download forked mmt repo
$ git clone https://github.com/MAAP-Project/mmt

# install cdk dependencies
$ cd mmt/deployment
$ # create python venv and activate
$ pip install -r requirements.txt
$ npm install
```

2. CDK bootstrap. This step is only necessary once per AWS account / region combination.

```
$ AWS_REGION=us-west-2
$ AWS_ACCOUNT_ID=$(aws sts get-caller-identity | jq .Account -r)
$ npm run cdk bootstrap aws://${AWS_ACCOUNT_ID}/${AWS_REGION}
```

3. Populate Secrets and Parameters

First, check if these secrets have been populated in AWS Secrets Manager. If not, create them as below.

For the GitHub secret, create a GitHub Personal Access Token with scopes `repo` and `admin:repo_hook`. 
This value will be substituted for
the value of the `token` attribute (e.g., `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`) in the GitHub 
credentials secret.

```
aws secretsmanager create-secret --name "/github.com/MAAP-Project/mmt" \
    --description "GitHub credentials for MAAP-Project" \
    --secret-string '{"token": "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"}'
```

For the DockerHub secret, replace the username and password below the appropriate values.

```
aws secretsmanager create-secret --name "/hub.docker.com/MAAP-Project/mmt" \
    --description "DockerHub credentials for MAAP-Project" \
    --secret-string '{"username": "<THE USERNAME>", "password": "<THE PASSWORD>"}'
```

Next, populate the per-stage parameters. These may already be populated, so first check in `AWS Console -> Systems Manager -> Parameter Store`. Set the `STAGE` variable to the appropriate stage.

```bash
export MMT_STACK_STAGE=dit
export AWS_REGION=us-west-2

aws ssm put-parameter \
    --type "SecureString" \
    --overwrite \
    --name "/${MMT_STACK_STAGE}-maap-mmt/EARTHDATA_PASSWORD" \
    --value "<the password>"

aws ssm put-parameter \
    --type "SecureString" \
    --overwrite \
    --name "/${MMT_STACK_STAGE}-maap-mmt/CMR_URS_PASSWORD" \
    --value "<the password>"

aws ssm put-parameter \
    --type "SecureString" \
    --overwrite \
    --name "/${MMT_STACK_STAGE}-maap-mmt/SECRET_KEY_BASE" \
    --value "<the secret key base>"

aws ssm put-parameter \
    --type "SecureString" \
    --overwrite \
    --name "/${MMT_STACK_STAGE}-maap-mmt/URS_PASSWORD" \
    --value "<the urs password>"

aws ssm put-parameter \
    --type "String" \
    --overwrite \
    --name "/${MMT_STACK_STAGE}-maap-mmt/EARTHDATA_USERNAME" \
    --value "devseed"

aws ssm put-parameter \
    --type "String" \
    --overwrite \
    --name "/${MMT_STACK_STAGE}-maap-mmt/CUMULUS_REST_API" \
    --value "https://1i4283wnch.execute-api.us-east-1.amazonaws.com/dev/"
```

These two will use `ops` in the hostname value instead of MMT_STACK_STAGE in production:

```
aws ssm put-parameter \
    --type "String" \
    --overwrite \
    --name "/${MMT_STACK_STAGE}-maap-mmt/CMR_ROOT" \
    --value "cmr.${MMT_STACK_STAGE}.maap-project.org"

aws ssm put-parameter \
    --type "String" \
    --overwrite \
    --name "/${MMT_STACK_STAGE}-maap-mmt/MMT_ROOT" \
    --value "https://mmt.${MMT_STACK_STAGE}.maap-project.org"
```

4. Generate CloudFormation template

This step isn't required, but can be useful to just validate that the configuration.

Synthesize the template to validate it basically works.

```bash
$ npm run cdk synth
```

5. Deploy the Inception Pipeline

This deploy step will deploy a CloudFormation Stack with a CodePipeline build that will then deploy the application stack.

```bash
export CDK_DEPLOY_ACCOUNT=$(aws sts get-caller-identity | jq .Account -r)
export CDK_DEPLOY_REGION=us-west-2
export MMT_STACK_STAGE="dit"

$ npm run cdk deploy -- --require-approval never
```

This pipeline will then deploy the application stack that creates a Postgres database, generates a docker image for the application, configures an ECS Task Definition and Service that uses that Task Definition, configures an application load balancer (ALB) to point to the ECS Service, and configures a custom DNS entry for the service.

6. Undeploy (optional)

```bash
export CDK_DEPLOY_ACCOUNT=$(aws sts get-caller-identity | jq .Account -r)
export CDK_DEPLOY_REGION=$(aws configure get region)

$ npm run cdk destroy
```

## Developer notes

The route53 permission is added because we do a lookup for the custom domain. The sts:AssumeRote is added 
because the Build step fails without it, but I would have
thought it would have been added by default (this issue has been filed about that https://github.com/aws/aws-cdk/issues/16105).
